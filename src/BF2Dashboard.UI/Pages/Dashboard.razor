@page "/"
@inherits FluxorComponent
@using BF2Dashboard.Domain.BattlefieldApi
@using BF2Dashboard.UI.Store
@using BF2Dashboard.UI.Store.FriendList
@inject IDispatcher _dispatcher
@inject IState<FavoriteServerListState> _favoriteServerListState
@inject IState<FullServerListState> _fullServerListState
@inject IState<FriendListState> _friendListState

<h2>
    Battlefield 2 Servers
    <button class="btn btn-dark btn-sm" title="Refresh server data" @onclick="Refresh">
        <i class="bi bi-arrow-clockwise" style="font-size: 15pt;"></i>
    </button>
</h2>

<div>
    Friends:
    @if (_friendListState.Value.FriendList != null)
    {
        <ul>
            @foreach (var friend in _friendListState.Value.FriendList)
            {
                <li>@friend.Player.Tag @friend.Player.Name (on @friend.ServerInfo.Name)</li>
            }
        </ul>
    }
</div>

<div class="row">
@if (_fullServerListState.Value.ServerList == null || _favoriteServerListState.Value.ServerList == null)
{
    <LoadingSpinner/>
}
else
{
    <div class="col-md-6">
        <div class="pt-5 pb-2">
            <h3>All:</h3>
        </div>
        <div class="accordion accordion-flush bg-dark" id="mainAccordion">
            @foreach (var server in _fullServerListState.Value.ServerList)
            {
                <!-- All Servers -->
                <div class="accordion-item">
                    <div class="accordion-header" style="min-width: 300px;">
                        <div class="accordion-item d-flex justify-content-between align-items-center text-nowrap @server.IsPinned ? 'active' : ''">
                            <i class="bi @(server.IsPinned ? "bi-heart-fill" : "bi-heart") grow p-3" style="font-size: 20pt" @onclick="() => ToggleFavorite(server)" title="Add or remove from favorites">
                            </i>
                            <button class="accordion-button collapsed btn @(server.NumPlayersWithoutBots == 0 ? "disabled" : "")" type="button" data-bs-toggle="collapse" aria-expanded="false" data-bs-target="#collapsed_@server.Guid">
                                <span class="badge bg-primary rounded-pill me-3" title="Number of players (without bots)">@server.NumPlayersWithoutBots / @server.MaxPlayers</span>
                                <div class="container">
                                    <div class="row">
                                        @server.Name
                                    </div>
                                    <div class="row">
                                        <small>
                                            @server.MapName
                                        </small>
                                    </div>
                                </div>
                            </button>
                        </div>

                        <div id="collapsed_@server.Guid" class="accordion-collapse collapse">
                            <div class="accordion-body ps-5 pe-3 pb-5">
                                <div class="row">
                                    <div class="col ps-5">
                                        <!-- Scoreboard -->
                                        <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                            <thead class="mb-1">
                                            <tr>
                                                <th scope="col" class="align-middle text-truncate">@server.Team1 Player</th>
                                                <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                <th style="width: 0;"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var player in server.Players
                                                .Where(p => p.IsHuman)
                                                .Where(p => p.TeamLabel == server.Team1)
                                                .OrderByDescending(p => p.Score)
                                                .ToList())
                                            {
                                                <tr>
                                                    <td style="vertical-align: center;">
                                                        <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                           href="https://www.bf2hub.com/player/@player.Name">
                                                            <span>@player.Tag @player.Name</span>
                                                        </a>
                                                    </td>
                                                    <td class="text-center">
                                                        @player.Score
                                                    </td>
                                                    <td class="text-center">
                                                        <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col ps-5">
                                        <!-- Scoreboard -->
                                        <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                            <thead>
                                            <tr>
                                                <th scope="col" class="align-middle text-truncate">@server.Team2 Player</th>
                                                <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                <th style="width: 0;"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var player in server.Players
                                                .Where(p => p.IsHuman)
                                                .Where(p => p.TeamLabel == server.Team2)
                                                .OrderByDescending(p => p.Score)
                                                .ToList())
                                            {
                                                <tr>
                                                    <td>
                                                        <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                           href="https://www.bf2hub.com/player/@player.Name">
                                                            <span>@player.Tag @player.Name</span>
                                                        </a>
                                                    </td>
                                                    <td class="text-center">
                                                        @player.Score
                                                    </td>
                                                    <td class="text-center">
                                                        <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="col-md-6">
        <div class="pt-5 pb-2">
            <h3>Your favorites:</h3>
        </div>
        <div class="accordion accordion-flush bg-dark" id="favoritesAccordion">
            @if (_favoriteServerListState.Value.ServerList?.Any() == true)
            {
                foreach (var server in _favoriteServerListState.Value.ServerList)
                {
                    <!-- Favorites -->
                    <div class="accordion-item">
                        <div class="accordion-header" style="min-width: 300px;">
                            <div class="accordion-item d-flex justify-content-between align-items-center text-nowrap @server.IsPinned ? 'active' : ''">
                                <i class="bi bi-trash grow p-3" style="font-size: 15pt" @onclick="() => ToggleFavorite(server)" title="Remove from favorites">
                                </i>
                                <button class="accordion-button collapsed btn @(server.NumPlayersWithoutBots == 0 ? "disabled" : "")" type="button" data-bs-toggle="collapse" aria-expanded="false" data-bs-target="#collapsed_favorite_@server.Guid">
                                    <span class="badge bg-primary rounded-pill me-3" title="Number of players (without bots)">@server.NumPlayersWithoutBots / @server.MaxPlayers</span>
                                    <div class="container">
                                        <div class="row">
                                            @server.Name
                                        </div>
                                        <div class="row">
                                            <small>
                                                @server.MapName
                                            </small>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <div id="collapsed_favorite_@server.Guid" class="accordion-collapse collapse">
                                <div class="accordion-body ps-5 pe-3 pb-5">
                                    <div class="row">
                                        <div class="col ps-5">
                                            <!-- Scoreboard -->
                                            <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                                <thead>
                                                <tr>
                                                    <th scope="col" class="align-middle text-truncate">@server.Team1 Player</th>
                                                    <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                    <th style="width: 0;"></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var player in server.Players
                                                    .Where(p => p.IsHuman)
                                                    .Where(p => p.TeamLabel == server.Team1)
                                                    .OrderByDescending(p => p.Score)
                                                    .ToList())
                                                {
                                                    <tr>
                                                        <td>
                                                            <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                               href="https://www.bf2hub.com/player/@player.Name">
                                                                <span>@player.Tag @player.Name</span>
                                                            </a>
                                                        </td>
                                                        <td class="text-center">
                                                            @player.Score
                                                        </td>
                                                        <td class="text-center">
                                                            <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                        </td>
                                                    </tr>
                                                }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col ps-5">
                                            <!-- Scoreboard -->
                                            <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                                <thead>
                                                <tr>
                                                    <th scope="col" class="align-middle text-truncate">@server.Team2 Player</th>
                                                    <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                    <th style="width: 0;"></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var player in server.Players
                                                    .Where(p => p.IsHuman)
                                                    .Where(p => p.TeamLabel == server.Team2)
                                                    .OrderByDescending(p => p.Score)
                                                    .ToList())
                                                {
                                                    <tr>
                                                        <td>
                                                            <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                               href="https://www.bf2hub.com/player/@player.Name">
                                                                <span>@player.Tag @player.Name</span>
                                                            </a>
                                                        </td>
                                                        <td class="text-center">
                                                            @player.Score
                                                        </td>
                                                        <td class="text-center">
                                                            <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                        </td>
                                                    </tr>
                                                }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <span style="font-size: 10pt; color: #767676">(Empty)</span>
            }
        </div>
    </div>
}
</div>

@code {
    private bool _isServerDataLoaded = false;
    private bool _isFriendListLoaded = false;

    protected override void OnInitialized()
    {
        if (!_isServerDataLoaded)
        {
            _dispatcher.Dispatch(new InitializeServerListsAction());
            _isServerDataLoaded = true;
        }

        if (_isServerDataLoaded && !_isFriendListLoaded)
        {
            _dispatcher.Dispatch(new InitializeFriendListAction());
            _isFriendListLoaded = true;
        }

        base.OnInitialized();
    }

    private void Refresh()
    {
        _dispatcher.Dispatch(new SetFullServerListAction(null));
        _dispatcher.Dispatch(new SetFavoriteServerListAction(null));
        _dispatcher.Dispatch(new InitializeServerListsAction());
        _dispatcher.Dispatch(new InitializeFriendListAction());
    }

    private void ToggleFavorite(Server server)
    {
        _dispatcher.Dispatch(new ToggleFavoriteAction(server));
    }

    private void AddFriend(int playerPid)
    {
        _dispatcher.Dispatch(new AddFriendAction(playerPid));
    }

}