@page "/"
@inherits FluxorComponent
@using BF2Dashboard.Domain.BattlefieldApi
@using BF2Dashboard.UI.Store
@inject IDispatcher _dispatcher
@inject IState<FavoriteServerListState> _favoriteServerListState
@inject IState<FullServerListState> _fullServerListState

<h2>
    Battlefield 2 Servers
    <button class="btn btn-dark btn-sm" title="Refresh server data" @onclick="Refresh">
        <i class="bi bi-arrow-clockwise" style="font-size: 15pt;"></i>
    </button>
</h2>

<div class="row">
@if (_fullServerListState.Value.ServerList == null || _favoriteServerListState.Value.ServerList == null)
{
    <LoadingSpinner/>
}
else
{
    <div class="col-md-6">
        <div class="pt-5 pb-2">
            <h3>All:</h3>
        </div>
        <div class="accordion accordion-flush bg-dark" id="mainAccordion">
            @foreach (var server in _fullServerListState.Value.ServerList)
            {
                <!-- All Servers -->
                <div class="accordion-item">
                    <div class="accordion-header" style="min-width: 300px;">
                        <div class="accordion-item d-flex justify-content-between align-items-center text-nowrap @server.IsPinned ? 'active' : ''">
                            <i class="bi @(server.IsPinned ? "bi-heart-fill" : "bi-heart") grow p-3" style="font-size: 20pt" @onclick="() => ToggleFavorite(server)" title="Add or remove from favorites">
                            </i>
                            <button class="accordion-button collapsed btn @(server.NumPlayersWithoutBots == 0 ? "disabled" : "")" style="min-width: 500px;"
                                    type="button" data-bs-toggle="collapse" aria-expanded="false" data-bs-target="#collapsed_@server.Guid">
                                <div class="col" style="min-width: 73px;">
                                    <span class="badge bg-primary rounded-pill me-3" title="Number of players (not counting bots)">@server.NumPlayersWithoutBots / @server.MaxPlayers</span>
                                </div>
                                <div id="serverIcons" class="row align-middle">
                                    <div class="col-1">
                                        @if (server.Ranked)
                                        {
                                            <img src="img/ranked.png" alt="Ranked" title="Ranked"/>
                                        }
                                        else
                                        {
                                            <img src="img/unranked.png" alt="Unranked" title="Unranked"/>
                                        }
                                    </div>
                                    <div class="col-1">
                                        @if (server.Battlerecorder)
                                        {
                                            <i class="bi bi-camera-video" style="font-size: 14px;" title="Battlerecorder is enabled"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-camera-video-off opacity-25" style="font-size: 14px;" title="Battlerecorder not enabled"></i>
                                        }
                                    </div>
                                    <div class="col-1">
                                        @if (server.Password)
                                        {
                                            <i class="bi bi-lock-fill" style="font-size: 14px;" title="Requires password"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-unlock" style="opacity: .1; font-size: 14px;" title="Has no password"></i>
                                        }
                                    </div>
                                </div>
                                <div id="serverText" class="container">
                                    <div class="row dynamic-server-name-width-xs dynamic-server-name-width-sm dynamic-server-name-width-md dynamic-server-name-width-lg"
                                         style="display: inline-block; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                                        @server.Name
                                    </div>
                                    <div class="row">
                                        <small>
                                            @server.MapName
                                        </small>
                                    </div>
                                </div>
                            </button>
                        </div>

                        <div id="collapsed_@server.Guid" class="accordion-collapse collapse">
                            <div class="accordion-body ps-5 pe-3 pb-5">
                                <div class="row d-flex justify-content-center text-center">
                                    <span class="mb-4">
                                        <small><strong>Server IP</strong>: @server.Ip:@server.Port</small>
                                    </span>
                                </div>
                                <div class="row">
                                    <div class="col ps-5">
                                        <!-- Scoreboard -->
                                        <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                            <thead class="mb-1">
                                            <tr>
                                                <th scope="col" class="align-middle text-truncate">@server.Team1 Player</th>
                                                <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                <th style="width: 0;"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var player in server.Players
                                                .Where(p => p.IsHuman)
                                                .Where(p => p.TeamLabel == server.Team1)
                                                .OrderByDescending(p => p.Score)
                                                .ToList())
                                            {
                                                <tr>
                                                    <td style="vertical-align: center;">
                                                        <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                           href="https://www.bf2hub.com/player/@player.Name">
                                                            <span>@player.Tag @player.Name</span>
                                                        </a>
                                                    </td>
                                                    <td class="text-center">
                                                        @player.Score
                                                    </td>
                                                    <td class="text-center">
                                                        <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col ps-5">
                                        <!-- Scoreboard -->
                                        <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                            <thead>
                                            <tr>
                                                <th scope="col" class="align-middle text-truncate">@server.Team2 Player</th>
                                                <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                <th style="width: 0;"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var player in server.Players
                                                .Where(p => p.IsHuman)
                                                .Where(p => p.TeamLabel == server.Team2)
                                                .OrderByDescending(p => p.Score)
                                                .ToList())
                                            {
                                                <tr>
                                                    <td>
                                                        <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                           href="https://www.bf2hub.com/player/@player.Name">
                                                            <span>@player.Tag @player.Name</span>
                                                        </a>
                                                    </td>
                                                    <td class="text-center">
                                                        @player.Score
                                                    </td>
                                                    <td class="text-center">
                                                        <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="col-md-6">
        <div class="pt-5 pb-2">
            <h3>Your favorites:</h3>
        </div>
        <div class="accordion accordion-flush bg-dark" id="favoritesAccordion">
            @if (_favoriteServerListState.Value.ServerList?.Any() == true)
            {
                foreach (var server in _favoriteServerListState.Value.ServerList)
                {
                    <!-- Favorites -->
                    <div class="accordion-item">
                        <div class="accordion-header" style="min-width: 300px;">
                            <div class="accordion-item d-flex justify-content-between align-items-center text-nowrap @server.IsPinned ? 'active' : ''">
                                <i class="bi bi-trash grow p-3" style="font-size: 15pt" @onclick="() => ToggleFavorite(server)" title="Remove from favorites">
                                </i>
                                <button class="accordion-button collapsed btn @(server.NumPlayersWithoutBots == 0 ? "disabled" : "")" type="button" data-bs-toggle="collapse" aria-expanded="false" data-bs-target="#collapsed_favorite_@server.Guid">
                                    <div class="col" style="min-width: 73px;">
                                        <span class="badge bg-primary rounded-pill me-3" title="Number of players (not counting bots)">@server.NumPlayersWithoutBots / @server.MaxPlayers</span>
                                    </div>
                                    <div id="serverIcons" class="row align-middle">
                                        <div class="col-1">
                                            @if (server.Ranked)
                                            {
                                                <img src="img/ranked.png" alt="Ranked" title="Ranked"/>
                                            }
                                            else
                                            {
                                                <img src="img/unranked.png" alt="Unranked" title="Unranked"/>
                                            }
                                        </div>
                                        <div class="col-1">
                                            @if (server.Battlerecorder)
                                            {
                                                <i class="bi bi-camera-video" style="font-size: 14px;" title="Battlerecorder is enabled"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-camera-video-off opacity-25" style="font-size: 14px;" title="Battlerecorder not enabled"></i>
                                            }
                                        </div>
                                        <div class="col-1">
                                            @if (server.Password)
                                            {
                                                <i class="bi bi-lock-fill" style="font-size: 14px;" title="Requires password"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-unlock" style="opacity: .1; font-size: 14px;" title="Has no password"></i>
                                            }
                                        </div>
                                    </div>
                                    <div id="serverText" class="container">
                                        <div class="row dynamic-server-name-width-xs dynamic-server-name-width-sm dynamic-server-name-width-md dynamic-server-name-width-lg"
                                             style="display: inline-block; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
                                            @server.Name
                                        </div>
                                        <div class="row">
                                            <small>
                                                @server.MapName
                                            </small>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <div id="collapsed_favorite_@server.Guid" class="accordion-collapse collapse">
                                <div class="accordion-body ps-5 pe-3 pb-5">
                                    <div class="row d-flex justify-content-center text-center">
                                        <span class="mb-4">
                                            <small><strong>Server IP</strong>: @server.Ip:@server.Port</small>
                                        </span>
                                    </div>
                                    <div class="row">
                                        <div class="col ps-5">
                                            <!-- Scoreboard -->
                                            <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                                <thead>
                                                <tr>
                                                    <th scope="col" class="align-middle text-truncate">@server.Team1 Player</th>
                                                    <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                    <th style="width: 0;"></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var player in server.Players
                                                    .Where(p => p.IsHuman)
                                                    .Where(p => p.TeamLabel == server.Team1)
                                                    .OrderByDescending(p => p.Score)
                                                    .ToList())
                                                {
                                                    <tr>
                                                        <td>
                                                            <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                               href="https://www.bf2hub.com/player/@player.Name">
                                                                <span>@player.Tag @player.Name</span>
                                                            </a>
                                                        </td>
                                                        <td class="text-center">
                                                            @player.Score
                                                        </td>
                                                        <td class="text-center">
                                                            <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                        </td>
                                                    </tr>
                                                }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col ps-5">
                                            <!-- Scoreboard -->
                                            <table id="scoreboard" class="table table-sm table-hover table-borderless">
                                                <thead>
                                                <tr>
                                                    <th scope="col" class="align-middle text-truncate">@server.Team2 Player</th>
                                                    <th style="width: 5%;" scope="col" class="align-middle text-center">Score</th>
                                                    <th style="width: 0;"></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var player in server.Players
                                                    .Where(p => p.IsHuman)
                                                    .Where(p => p.TeamLabel == server.Team2)
                                                    .OrderByDescending(p => p.Score)
                                                    .ToList())
                                                {
                                                    <tr>
                                                        <td>
                                                            <a title="Open BF2Hub profile" class="link-light text-nowrap text-decoration-none" target="_blank"
                                                               href="https://www.bf2hub.com/player/@player.Name">
                                                                <span>@player.Tag @player.Name</span>
                                                            </a>
                                                        </td>
                                                        <td class="text-center">
                                                            @player.Score
                                                        </td>
                                                        <td class="text-center">
                                                            <i class="btn btn-sm btn-outline-success bi bi-person-plus grow" @onclick="() => AddFriend(player.Pid)" title="Mark as friend"></i>
                                                        </td>
                                                    </tr>
                                                }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <span style="font-size: 10pt; color: #767676">(Empty)</span>
            }
        </div>
    </div>
}
</div>

@code {
    private bool _isDataLoaded = false;

    protected override void OnInitialized()
    {
        if (!_isDataLoaded)
        {
            _dispatcher.Dispatch(new InitializeServerListsAction());
            _isDataLoaded = true;
        }

        base.OnInitialized();
    }

    private void Refresh()
    {
        _dispatcher.Dispatch(new SetFullServerListAction(null));
        _dispatcher.Dispatch(new SetFavoriteServerListAction(null));
        _dispatcher.Dispatch(new InitializeServerListsAction());
    }

    private void ToggleFavorite(Server server)
    {
        _dispatcher.Dispatch(new ToggleFavoriteAction(server));
    }

    private void AddFriend(int playerPid)
    {
    }

}